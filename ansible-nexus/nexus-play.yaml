---
- name: Update machine
  hosts: nexus-server
  vars_files:
    - project-vars
  tasks:
    - name: Update apt repo and cache
      apt: update_cache=yes force_apt_get=yes
    - name: Install java and net tools
      apt:
        pkg:
          - openjdk-8-jre-headless
          - net-tools

- name: Download and install nexus
  hosts: nexus-server
  vars_files:
    - project-vars
  tasks:
    - name: Download nexus
      get_url:
        url: https://download.sonatype.com/nexus/3/latest-unix.tar.gz
        dest: /opt/
      register: file_location
    - name: Untar nexus installer
      unarchive:
        src: "{{ file_location.dest }}"
        dest: /opt/
        remote_src: yes
    - name: Find nexus folder
      find:
        paths: /opt
        pattern: "nexus-*"
        file_type: directory
      register: find_result
    - name: Check if nexus folder already exists
      stat:
        path: /opt/nexus
      register: stat_result
    - name: Rename nexus folder
      shell: mv {{ find_result.files[0].path }} /opt/nexus
      when: not stat_result.stat.exists
